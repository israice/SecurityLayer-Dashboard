<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecurityLayer</title>
</head>
<body>
    <div id="app" style="visibility:hidden"></div>
    <script>
        const app = document.getElementById('app');

        window.loadPage = async (page) => {
            // hide before swap
            app.style.visibility = 'hidden';

            const res = await fetch('/static/' + page + '/index.html');
            const html = await res.text();

            // parse full HTML, extract body and head
            const doc = new DOMParser().parseFromString(html, 'text/html');

            // load CSS <link> and Google Fonts — wait for each stylesheet to load
            const cssPromises = [];
            doc.querySelectorAll('link[rel="stylesheet"], link[href*="fonts.googleapis.com"], link[href*="fonts.gstatic.com"]').forEach(link => {
                const href = link.getAttribute('href');
                if (!document.querySelector(`link[href="${href}"]`)) {
                    const clone = link.cloneNode();
                    if (clone.rel === 'stylesheet') {
                        cssPromises.push(new Promise((resolve) => {
                            clone.onload = resolve;
                            clone.onerror = resolve; // не блокируем при ошибке
                        }));
                    }
                    document.head.appendChild(clone);
                }
            });

            // load <style> blocks
            doc.querySelectorAll('style').forEach(style => {
                document.head.appendChild(style.cloneNode(true));
            });

            // set body content (hidden)
            app.innerHTML = doc.body.innerHTML;

            // execute scripts and wait for external ones to load
            const scriptPromises = [];
            doc.querySelectorAll('script').forEach(oldScript => {
                const newScript = document.createElement('script');
                if (oldScript.src) {
                    scriptPromises.push(new Promise((resolve, reject) => {
                        newScript.onload = resolve;
                        newScript.onerror = reject;
                    }));
                    newScript.src = oldScript.src;
                } else {
                    newScript.textContent = oldScript.textContent;
                }
                document.body.appendChild(newScript);
            });

            // update title
            const title = doc.querySelector('title');
            if (title) document.title = title.textContent;

            // show only after all CSS and scripts loaded
            try { await Promise.all([...cssPromises, ...scriptPromises]); } catch (_) {}
            app.style.visibility = 'visible';
        };

        // Route based on session
        try {
            const user = JSON.parse(sessionStorage.getItem('user'));
            if (user) {
                loadPage('dashboard-page');
            } else {
                loadPage('landing-page');
            }
        } catch(e) {
            sessionStorage.clear();
            loadPage('landing-page');
        }
    </script>
</body>
</html>
